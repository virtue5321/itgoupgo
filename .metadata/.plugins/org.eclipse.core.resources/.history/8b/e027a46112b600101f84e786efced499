<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %> 
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>정보 공유 게시판 관리</title>

    <link rel="stylesheet" href="<c:url value="/resources/css/adminStyle.css" />">
    <style>
        /* 💡 [CSS 추가] 삭제된 게시글 행 스타일 */
        .deleted-post {
            background-color: #f8f8f8; /* 배경색을 연한 회색으로 */
            color: #999; /* 폰트 색상을 회색으로 */
            text-decoration: line-through; /* 취소선 */
        }
        /* 삭제된 게시글 내의 링크, 텍스트 색상도 회색으로 통일 */
        .deleted-post a, .deleted-post .text-danger, .deleted-post .text-secondary {
            color: #999 !important;
        }
    </style>
</head>
<body>
    
    <header>
        <div class="logo">
            <img src="<c:url value="/resources/images/logo1.PNG" />" width="80">
            관리자 페이지
        </div>
    </header>

    <div class="layout">
        <%-- ✅ 사이드바: 정보 공유 게시판 활성화 --%>
        <aside class="sidebar">
            <ul>
                <li><a href="<c:url value="/admin/dashboard" />">🏠 대시보드</a></li>
                <li><a href="<c:url value="/admin/member" />">👥 회원 관리</a></li>

                <%-- '게시글 관리' 메뉴 활성화 --%>
                <li id="postManageMenu" class="menu-open">
                    <a href="javascript:void(0);" onclick="toggleSubmenu('postManageMenu')">📝 게시글 관리</a>
                    <ul class="submenu">
                        <li><a href="<c:url value="/admin/post/noticeList" />">공지사항 관리</a></li>
                        <li><a href="<c:url value="/admin/post/freeList" />">자유 게시판 관리</a></li>
                        <%-- 현재 페이지: 정보 공유 게시판 활성화 --%>
                        <li><a href="<c:url value="/admin/post/infoList" />" class="active">정보 공유 게시판 관리</a></li>
                        <li><a href="<c:url value="/admin/post/itList" />">IT 뉴스 관리</a></li>
                        <li><a href="<c:url value="/admin/post/knowledgeList" />">지식 공유 관리</a></li>
                    </ul>
                </li>
            </ul>
        </aside>

        <%-- ✅ 본문 내용 --%>
        <main class="content">
            <h1 class="page-title">정보 공유 게시판 관리</h1>

            <div class="board-header">
                <span class="total-count">
                    총 게시글 수: <strong>${pageInfo.listCount}</strong>개
                </span>
                
                <div class="action-buttons">
                    <!-- 일괄 삭제 폼 (숨겨진 폼) -->
                    <form id="bulkDeleteForm" action="<c:url value="/admin/info/delete" />" method="post" style="display:none;"></form>

                    <button class="btn btn-danger" onclick="bulkDeletePost()">
                        <i class="fas fa-trash-alt"></i> 선택 게시글 일괄 삭제
                    </button>
                </div>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">
                            <input type="checkbox" id="selectAllCheckboxPost">
                        </th>
                        <th style="width: 8%;">번호</th>
                        <th style="width: 45%;">제목</th>
                        <th style="width: 10%;">작성자</th>
                        <th style="width: 12%;">작성일</th>
                        <th style="width: 8%;">조회수</th>
                        <th style="width: 12%;">관리</th>
                    </tr>
                </thead>
                <tbody>
                    <c:choose>
                        <c:when test="${empty bbsList}">
                            <tr>
                                <td colspan="7" class="text-center">등록된 게시글이 없습니다.</td>
                            </tr>
                        </c:when>
                        <c:otherwise>
                            <%-- 게시글 목록 반복 출력 --%>
                            <c:forEach var="bbs" items="${bbsList}">
                                <%-- ⭐️ [수정] InfoBbs VO 객체 속성 사용 --%>
                                <tr class="<c:if test="${bbs.infoDeleteStatus eq 'Y'}">deleted-post</c:if>">
                                    <td>
                                        <input type="checkbox" class="itemCheckboxPost" name="bbsNo" value="${bbs.infoNo}"
                                            <c:if test="${bbs.infoDeleteStatus eq 'Y'}">disabled</c:if>>
                                    </td>
                                    <td>${bbs.infoNo}</td>
                                    <td class="text-left">
                                        <%-- ⭐️ [수정] InfoBbs VO 객체 속성 및 URL 사용 --%>
                                        <c:choose>
                                            <c:when test="${bbs.infoDeleteStatus eq 'Y'}">
                                                <span class="text-secondary">${bbs.infoTitle} (삭제됨)</span>
                                            </c:when>
                                            <c:otherwise>
                                                <a href="<c:url value="/info/detail?no=${bbs.infoNo}" />" target="_blank" title="게시글 상세 보기">
                                                    ${bbs.infoTitle}
                                                </a>
                                            </c:otherwise>
                                        </c:choose>
                                    </td>
                                    <%-- ⭐️ [수정] 에러의 원인이었던 memberNick 사용 --%>
                                    <td>${bbs.memberNick}</td> 
                                    <td>
                                        <fmt:formatDate value="${bbs.infoCreateDate}" pattern="yy-MM-dd HH:mm"/>
                                    </td>
                                    <td>${bbs.infoView}</td>
                                    <td>
                                        <%-- ⭐️ [수정] 개별 삭제 함수에 InfoBbs No 전달 --%>
                                        <button class="btn btn-sm btn-delete" 
                                                onclick="deletePost(${bbs.infoNo})"
                                                <c:if test="${bbs.infoDeleteStatus eq 'Y'}">disabled</c:if>>
                                            삭제
                                        </button>
                                    </td>
                                </tr>
                            </c:forEach>
                        </c:otherwise>
                    </c:choose>
                </tbody>
            </table>

            <%-- ✅ 페이지네이션 영역 --%>
            <div class="pagination">
                <c:set var="pi" value="${pageInfo}"/>
                
                <%-- 맨 처음으로 (<<) --%>
                <a href="<c:url value="/admin/post/infoList?currentPage=1" />" 
                   class="page-link <c:if test="${pi.currentPage eq 1}">disabled</c:if>">
                    &lt;&lt;
                </a>
                
                <%-- 이전 페이지 그룹으로 (<) --%>
                <a href="<c:url value="/admin/post/infoList?currentPage=${pi.startPage - 1}" />" 
                   class="page-link <c:if test="${pi.currentPage eq 1}">disabled</c:if>">
                    &lt;
                </a>
                
                <%-- 페이지 번호 --%>
                <c:forEach var="p" begin="${pi.startPage}" end="${pi.endPage}">
                    <a href="<c:url value="/admin/post/infoList?currentPage=${p}" />" 
                       class="page-link <c:if test="${pi.currentPage eq p}">active</c:if>">
                        ${p}
                    </a>
                </c:forEach>
                
                <%-- 다음 페이지 그룹으로 (>) --%>
                <a href="<c:url value="/admin/post/infoList?currentPage=${pi.endPage + 1}" />" 
                   class="page-link <c:if test="${pi.currentPage eq pi.maxPage}">disabled</c:if>">
                    &gt;
                </a>
                
                <%-- 맨 끝으로 (>>) --%>
                <a href="<c:url value="/admin/post/infoList?currentPage=${pi.maxPage}" />" 
                   class="page-link <c:if test="${pi.currentPage eq pi.maxPage}">disabled</c:if>">
                    &gt;&gt;
                </a>
            </div>

        </main>
    </div>

    <%-- ✅ JavaScript: 사이드바 토글, 삭제 기능 --%>
    <script>
    /**
     * 사이드바 서브메뉴 토글 기능
     * @param {string} menuId - 토글할 메뉴 항목의 ID
     */
    function toggleSubmenu(menuId) {
        const menu = document.getElementById(menuId);
        menu.classList.toggle('menu-open');
    }

    /**
     * 개별 게시글 삭제 처리 (실제로는 삭제 상태 UPDATE)
     * @param {number} bbsNo - 삭제할 게시글 번호 (InfoBbs No)
     */
    function deletePost(bbsNo) {
        // ⭐️ [수정] 삭제 요청 URL을 /admin/info/delete로 변경
        const deleteUrl = "<c:url value="/admin/info/delete" />";

        if (confirm(`${bbsNo}번 게시글을 정말 삭제(비활성화) 처리하시겠습니까?`)) {
            // 히든 폼을 생성하여 POST 요청으로 삭제 처리
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = deleteUrl;

            // 게시글 번호를 담을 hidden input
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'bbsNoList'; // 단건 삭제도 배열로 받도록 통일
            input.value = bbsNo;
            form.appendChild(input);

            document.body.appendChild(form);
            form.submit();
        }
    }

    /**
     * 선택된 게시글 일괄 삭제 처리
     */
    function bulkDeletePost() {
        const selectedCheckboxes = Array.from(document.querySelectorAll('.itemCheckboxPost:checked:not(:disabled)'))
                                      .filter(checkbox => {
                                          // 삭제 상태가 'Y'인 게시글은 체크박스가 disabled되어 있어야 하지만, 
                                          // 혹시 모를 경우를 대비하여 다시 한 번 필터링합니다.
                                          return !checkbox.closest('tr').classList.contains('deleted-post');
                                      });

        // 💡 [개선] alert 대신 커스텀 모달이나 토스트 메시지를 사용해야 하지만, 기존 로직 유지
        if (selectedCheckboxes.length === 0) {
            alert('일괄 삭제할 게시글을 1개 이상 선택해 주세요. (이미 삭제된 게시글은 제외됩니다.)'); return;
        }
        
        // 💡 [개선] confirm 대신 커스텀 모달을 사용해야 하지만, 기존 로직 유지
        if (confirm(`총 ${selectedCheckboxes.length}건의 게시글을 일괄 삭제 처리하시겠습니까?`)) {
            const form = document.getElementById('bulkDeleteForm');
            form.innerHTML = '';
            
            // 선택된 모든 게시글 번호를 hidden input으로 추가
            selectedCheckboxes.forEach(checkbox => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden'; 
                // name='bbsNoList'는 Controller에서 받는 @RequestParam 이름일 가능성이 높으므로 유지
                hiddenInput.name = 'bbsNoList'; 
                hiddenInput.value = checkbox.value;
                form.appendChild(hiddenInput);
            });
            form.submit();
        }
    }

    // 전체 선택/해제 로직
    document.addEventListener('DOMContentLoaded', (event) => {
        const selectAllCheckbox = document.getElementById('selectAllCheckboxPost');
        // :not(:disabled)를 사용하여 이미 삭제된 게시글의 체크박스는 제외
        const itemCheckboxes = document.querySelectorAll('.itemCheckboxPost:not(:disabled)');
        
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() { 
                itemCheckboxes.forEach(checkbox => { 
                    checkbox.checked = this.checked; 
                }); 
            });
        }

        itemCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const checkedItems = document.querySelectorAll('.itemCheckboxPost:checked').length;
                // 전체 개수는 disabled가 아닌 체크박스 개수
                const totalItems = itemCheckboxes.length; 
                
                if (selectAllCheckbox) {
                    if (!checkbox.checked) { 
                        selectAllCheckbox.checked = false; 
                    } else if (checkedItems === totalItems) { 
                        selectAllCheckbox.checked = true; 
                    }
                }
            });
        });
        
        // 페이지 로드 시 '게시글 관리' 메뉴를 열린 상태로 유지
        const postManageMenu = document.getElementById('postManageMenu');
        if (postManageMenu && !postManageMenu.classList.contains('menu-open')) {
             postManageMenu.classList.add('menu-open');
        }
    });
 </script>
</body>
</html>
