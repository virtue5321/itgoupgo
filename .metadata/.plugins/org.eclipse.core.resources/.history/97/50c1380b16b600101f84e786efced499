<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>

<!DOCTYPE html>

<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>관리자 - 지식인 게시판 관리</title>
    <link rel="stylesheet" href="<c:url value="/resources/css/adminStyle.css" />">
    <style>
        /* 💡 스타일은 noticeManage.jsp와 동일합니다 */
        .pagination-container {
            display: flex;
            justify-content: center; 
            padding: 20px 0;
            gap: 5px;
        }
        .pagination-container a, .pagination-container span {
            padding: 8px 12px;
            text-decoration: none;
            color: #333;
            border: 1px solid #ddd; 
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .pagination-container a:hover {
            background-color: #f0f0f0;
        }
        .pagination-container .active {
            background-color: #5a5ce8;
            color: white;
            border-color: #5a5ce8; 
        }
        .status-text.deleted { 
            color: red; 
            font-weight: bold; 
        }
        /* [추가] 삭제된 게시글 행 스타일 */
        .deleted-post { 
            background-color: #f8f8f8;
            color: #999; 
        }
        .deleted-post a, .deleted-post .status-text { 
            color: #999 !important;
        }
    </style>
</head>
<body>
    
    <header>
        <div class="logo">
            <img src="<c:url value="/resources/images/logo1.PNG" />" width="80">
            관리자 페이지
        </div>
    </header>

    <div class="layout">
        <%-- ✅ 사이드바: 지식인 게시판 활성화 --%>
        <aside class="sidebar">
            <ul>
                <li><a href="<c:url value="/admin/dashboard" />">🏠 대시보드</a></li>
                <li><a href="<c:url value="/admin/member" />">👥 회원 관리</a></li>

                <li id="postManageMenu" class="menu-open">
                    <a href="javascript:void(0);" onclick="toggleSubmenu('postManageMenu')">📝 게시글 관리</a>
                    
                    <ul class="submenu">
                        <li><a href="<c:url value="/admin/freeBbsManage" />">자유 게시판</a></li>
                        <li><a href="<c:url value="/admin/infoBbsManage" />">정보 공유 게시판</a></li>
                        <li><a href="<c:url value="/admin/itBbsManage" />">IT 뉴스 게시판</a></li>
                        <li><a href="<c:url value="/admin/noticeBbsManage" />">공지사항 게시판</a></li>
		                <li><a href="<c:url value="/admin/studyBbsManage" />">스터디 게시판</a></li>
		                <%-- [수정] 현재 페이지 활성화 --%>
                        <li class="sub-active"><a href="<c:url value="/admin/knowledgeBbsManage" />" class="sub-active">지식인 게시판</a></li>
                    </ul>
                </li>
                
                <li><a href="<c:url value="/admin/reply" />">💬 댓글 관리</a></li>
                <li><a href="<c:url value="/admin/stats" />">📊 통계</a></li>
                <li><a href="<c:url value="/admin/logout" />">🚪 로그아웃</a></li>
            </ul>
        </aside>

        <%-- ✅ 메인 컨텐츠 --%>
        <main>
            <h1>📝 지식인 게시글 관리</h1>
            <p>지식인 게시판에 등록된 게시글 목록을 확인하고 관리할 수 있습니다.</p>

            <form id="bulkDeleteForm" action="<c:url value="/admin/deleteKnowledgeBbsCheck" />" method="POST" style="display:none;"></form>

            <%-- [수정] 일괄 삭제 버튼 위치 및 문구 통일 --%>
            <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                <button class="btn btn-danger" onclick="deleteCheckedPosts()">선택 게시글 일괄 삭제</button>
            </div>

            <form action="<c:url value="/admin/deleteKnowledgeBbsCheck" />" method="POST" id="postManageForm">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">
                                <input type="checkbox" id="selectAllCheckboxPost">
                            </th>
                            <th style="width: 10%;">번호</th>
                            <th>제목</th>
                            <th style="width: 15%;">작성자(닉네임)</th>
                            <th style="width: 10%;">카테고리</th>
                            <th style="width: 15%;">작성일</th>
                            <th style="width: 10%;">상태</th>
                            <th style="width: 10%;">상세</th>
                        </tr>
                    </thead>
                    <tbody>
                        <c:choose>
                            <c:when test="${!empty knowledgeBbsList}">
                                <c:forEach var="post" items="${knowledgeBbsList}">
                                    <tr class="${post.knowledgeDeleteStatus eq 'Y' ? 'deleted-post' : ''}">
                                        <td>
                                            <input type="checkbox" class="itemCheckboxPost" name="bbsNoList" value="${post.knowledgeNo}"
                                                   <c:if test="${post.knowledgeDeleteStatus eq 'Y'}">disabled</c:if>>
                                        </td>
                                        <td>${post.knowledgeNo}</td>
                                        <td class="text-left">
                                            <c:choose>
                                                <c:when test="${post.knowledgeDeleteStatus eq 'Y'}">
                                                    <span class="status-text deleted">[삭제됨]</span> ${post.knowledgeTitle}
                                                </c:when>
                                                <c:otherwise>
                                                    <a href="<c:url value="/knowledge/detail?no=${post.knowledgeNo}" />" class="title-link" target="_blank">
                                                        ${post.knowledgeTitle}
                                                    </a>
                                                </c:otherwise>
                                            </c:choose>
                                        </td>
                                        <td>${post.memberNick}</td>
                                        <td>${post.knowledgeCategory}</td>
                                        <td><fmt:formatDate value="${post.knowledgeCreateDate}" pattern="yyyy.MM.dd" /></td>
                                        <td>
                                            <span class="status-text ${post.knowledgeDeleteStatus eq 'Y' ? 'deleted' : 'active'}">
                                                ${post.knowledgeDeleteStatus eq 'Y' ? '[비활성]' : '[활성]'}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-danger" 
                                                    onclick="deleteSinglePost(${post.knowledgeNo})"
                                                    <c:if test="${post.knowledgeDeleteStatus eq 'Y'}">disabled</c:if>>
                                                삭제
                                            </button>
                                        </td>
                                    </tr>
                                </c:forEach>
                            </c:when>
                            <c:otherwise>
                                <tr>
                                    <td colspan="8">조회된 지식인 게시글이 없습니다.</td>
                                </tr>
                            </c:otherwise>
                        </c:choose>
                    </tbody>
                </table>
            </form>

            <div class="pagination-container">
                <c:set var="pi" value="${pageInfo}"/>
                <c:set var="pageLinkUrl" value="/admin/knowledgeBbsManage" />
                
                <c:choose><c:when test="${pi.currentPage le 1}"><span class="disabled">&lt;&lt;</span></c:when><c:otherwise><a href="<c:url value="${pageLinkUrl}" />?currentPage=1">&lt;&lt;</a></c:otherwise></c:choose>
                <c:choose><c:when test="${pi.currentPage le 1}"><span class="disabled">&lt;</span></c:when><c:otherwise><a href="<c:url value="${pageLinkUrl}" />?currentPage=${pi.currentPage - 1}">&lt;</a></c:otherwise></c:choose>
                
                <c:forEach begin="${pi.startPage}" end="${pi.endPage}" var="p">
                    <c:choose><c:when test="${pi.currentPage eq p}"><span class="active">${p}</span></c:when><c:otherwise><a href="<c:url value="${pageLinkUrl}" />?currentPage=${p}">${p}</a></c:otherwise></c:choose>
                </c:forEach>
                
                <c:choose><c:when test="${pi.currentPage eq pi.maxPage || pi.maxPage eq 0}"><span class="disabled">&gt;</span></c:when><c:otherwise><a href="<c:url value="${pageLinkUrl}" />?currentPage=${pi.currentPage + 1}">&gt;</a></c:otherwise></c:choose>
                <c:choose><c:when test="${pi.currentPage eq pi.maxPage || pi.maxPage eq 0}"><span class="disabled">&gt;&gt;</span></c:when><c:otherwise><a href="<c:url value="${pageLinkUrl}" />?currentPage=${pi.maxPage}">&gt;&gt;</a></c:otherwise></c:choose>
            </div>
        </main>
    </div>

    <footer>ⓒ 2025 IT GO UP GO. All Rights Reserved.</footer>

    <script>
        // 사이드바 토글 함수 (새로운 템플릿에 맞게 추가)
        function toggleSubmenu(menuId) { 
            document.getElementById(menuId).classList.toggle('menu-open'); 
        }
        
        // [제거] validateSearch 함수 제거됨

        function deleteCheckedPosts() {
            // 삭제되지 않은 (disabled가 아닌) 게시글의 체크박스만 선택
            const selectedCheckboxes = document.querySelectorAll('.itemCheckboxPost:checked:not(:disabled)');

            if (selectedCheckboxes.length === 0) {
                alert("삭제할 게시글을 하나 이상 선택해주세요. (이미 삭제된 게시글 제외)"); 
                return; 
            }

            if (confirm(`선택된 게시글 ${selectedCheckboxes.length}개를 정말로 비활성화(삭제 처리)하시겠습니까?`)) {
                const formElement = document.getElementById('postManageForm');
                
                // 기존 히든 인풋 제거
                formElement.querySelectorAll('input[name="bbsNoList"]').forEach(input => input.remove());
                selectedCheckboxes.forEach(checkbox => {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'bbsNoList'; // Controller의 @RequestParam 이름과 일치
                    hiddenInput.value = checkbox.value;
                    formElement.appendChild(hiddenInput);
                });
                formElement.submit(); 
            }
        }

        // 단일 게시글 삭제 함수
        function deleteSinglePost(knowledgeNo) {
            if (confirm(`${knowledgeNo}번 게시글을 정말 삭제(비활성화) 처리하시겠습니까?`)) {
                location.href = "<c:url value="/admin/deleteKnowledgeBbs" />?knowledgeNo=" + knowledgeNo;
            }
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            const selectAllCheckbox = document.getElementById('selectAllCheckboxPost');
            // 삭제된 게시글 제외한 체크박스만 대상으로 함
            const itemCheckboxes = document.querySelectorAll('.itemCheckboxPost:not(:disabled)');
            
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    itemCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                });
            }
            
            itemCheckboxes.forEach(checkbox => { 
                checkbox.addEventListener('change', () => { 
                    const checkedItems = document.querySelectorAll('.itemCheckboxPost:checked:not(:disabled)').length;
                    const totalItems = itemCheckboxes.length;
                    
                    if (!checkbox.checked) {
                        if (selectAllCheckbox) selectAllCheckbox.checked = false;
                    } else if (checkedItems === totalItems) {
                        if (selectAllCheckbox) selectAllCheckbox.checked = true;
                    }
                });
            });

            // 게시글 관리 메뉴 열린 상태 유지 (새로운 템플릿에 맞게 추가)
            const postManageMenu = document.getElementById('postManageMenu');
            if (postManageMenu && !postManageMenu.classList.contains('menu-open')) {
                 postManageMenu.classList.add('menu-open');
            }
        });
    </script>

</body>
</html>