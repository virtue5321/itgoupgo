package com.itgoupgo.community.admin.controller;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import com.itgoupgo.community.admin.model.service.AdminService;
import com.itgoupgo.community.common.model.vo.Pagination;
import com.itgoupgo.community.free.model.service.FreeService; // [ì¶”ê°€ë¨] FreeService import
import com.itgoupgo.community.free.model.vo.FreeBbs; // ììœ ê²Œì‹œíŒ VO
import com.itgoupgo.community.info.model.service.InfoService;
import com.itgoupgo.community.info.model.vo.InfoBbs; // ì •ë³´ê³µìœ ê²Œì‹œíŒ VO
import com.itgoupgo.community.it.model.service.ItService;
import com.itgoupgo.community.it.model.vo.ItBbs; // ITë‰´ìŠ¤ VO
import com.itgoupgo.community.knowledge.model.service.KnowledgeService;
import com.itgoupgo.community.knowledge.model.vo.KnowledgeBbs; // ì§€ì‹ê³µìœ ê²Œì‹œíŒ VO
import com.itgoupgo.community.member.model.vo.Member;
import com.itgoupgo.community.notice.model.service.NoticeService;
import com.itgoupgo.community.notice.model.vo.NoticeBbs; // ê³µì§€ì‚¬í•­ VO
import com.itgoupgo.community.study.model.service.StudyService;
import com.itgoupgo.community.study.model.vo.StudyBbs; // ìŠ¤í„°ë””ëª¨ì§‘ê²Œì‹œíŒ VO

import jakarta.servlet.http.HttpSession;

@Controller
@RequestMapping("/admin") 
public class AdminController {
	
	@Autowired
	private AdminService adminService;
    
    @Autowired
    private FreeService freeService;

    @Autowired
    private InfoService infoService;
    
    @Autowired
    private StudyService studyService;
    
    @Autowired
    private NoticeService noticeService;
    
    @Autowired
    private KnowledgeService knowledgeService;
    
    @Autowired
    private ItService itService;
    
    @GetMapping({"", "/dashboard"})
    public String adminDashboard() {
        return "admin/admin"; 
    }
    
    // ê²Œì‹œê¸€ ê´€ë¦¬ ë©”ì¸ í˜ì´ì§€ (ê¸°ì¡´ ìœ ì§€)
    @GetMapping("/post")
    public String postManage() {
    	
    	return "admin/postManage";
    }
    
    @GetMapping("/reply")
    public String replyManage() {
        return "admin/replyManage";
    }

    @GetMapping("/stats")
    public String statsPage() {
        return "admin/stats";
    }

    @GetMapping("/logout")
    public String logout() {
        return "admin/logout"; // ì‹¤ì œ ë¡œê·¸ì•„ì›ƒ ë¡œì§ì€ ìƒëµ
    }

    /**
     * íšŒì› ëª©ë¡ ì¡°íšŒ í˜ì´ì§€ (í˜ì´ì§• ì ìš©) - (ê¸°ì¡´ ìœ ì§€)
     */
    @GetMapping("/member")
    public String memberManage(
        @RequestParam(value = "currentPage", defaultValue = "1") int currentPage, 
        Model model) {
        
        // 1. ì „ì²´ íšŒì› ìˆ˜ ì¡°íšŒ (listCount)
        int listCount = adminService.selectListCount(); 
        
        // 2. Pagination ê°ì²´ ìƒì„± (pageLimit, listLimitì€ Serviceì—ì„œ ì²˜ë¦¬í•œë‹¤ê³  ê°€ì •)
        Pagination pageInfo = adminService.getPagination(currentPage, listCount); // 
        
        // 3. í˜„ì¬ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” íšŒì› ëª©ë¡ ì¡°íšŒ
        List<Member> memberList = adminService.selectMemberList(pageInfo);
        
        // 4. ëª¨ë¸ì— ëª©ë¡ê³¼ í˜ì´ì§• ì •ë³´ë¥¼ ë‹´ì•„ ì „ë‹¬
        model.addAttribute("memberList", memberList);
        model.addAttribute("pageInfo", pageInfo);
        
        return "admin/memberManage";
    }
    
    // ----------------------------------------------------
    // 3. ê´€ë¦¬ìí˜ì´ì§€ íšŒì› ìƒì„¸ ì¡°íšŒ ê¸°ëŠ¥ (ê¸°ì¡´ ìœ ì§€)
    // ----------------------------------------------------
    @GetMapping("/memberDetail")
    public String memberDetail(
        @RequestParam("memberNo") int memberNo, // memberNoë¥¼ ì¿¼ë¦¬ìŠ¤íŠ¸ë§ìœ¼ë¡œ ë°›ìŒ
        Model model,
        HttpSession session) {
        
        Member member = adminService.selectMemberDetail(memberNo);
        
        if (member == null) {
            // ìƒì„¸ ì¡°íšŒì— ì‹¤íŒ¨í–ˆì„ ê²½ìš° (ì˜ˆ: ì˜ëª»ëœ memberNo)
            session.setAttribute("alertMsg", "í•´ë‹¹ íšŒì› ì •ë³´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return "redirect:/admin/member";
        }
        
        model.addAttribute("member", member);
        
        // ë·° ë¦¬ì¡¸ë²„ ì„¤ì •(application.properties)ì— ë”°ë¼
        // /WEB-INF/views/admin/memberDetail.jsp íŒŒì¼ì„ ì°¾ê²Œ ë¨
        return "admin/memberDetail"; 
    }
    
    // ----------------------------------------------------
    // 4. íšŒì› ë‹¨ì¼ íƒˆí‡´ ì²˜ë¦¬ (ê¸°ì¡´ ìœ ì§€)
    // ----------------------------------------------------
    @GetMapping("/delete")
    public String deleteMember(@RequestParam("memberId") String memberId, HttpSession session) {
        
        int result = adminService.deleteMemberAdmin(memberId);
        
        if (result > 0) {
            session.setAttribute("alertMsg", "íšŒì› (" + memberId + ") íƒˆí‡´ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            session.setAttribute("alertMsg", "íšŒì› íƒˆí‡´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }

        return "redirect:/admin/member";
    }
    
    // ----------------------------------------------------
    // 5. íšŒì› ì¼ê´„ íƒˆí‡´ ì²˜ë¦¬ (ê¸°ì¡´ ìœ ì§€)
    // ----------------------------------------------------
    @PostMapping("/deleteCheckMember")
    public String deleteCheckMember(
        @RequestParam(value = "memberNoList", required = false) List<Integer> memberNoList,
        HttpSession session) {

        if (memberNoList == null || memberNoList.isEmpty()) {
             session.setAttribute("alertMsg", "ì„ íƒëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.");
             return "redirect:/admin/member";
        }
        
        int result = adminService.deleteCheckMember(memberNoList);

        if (result == memberNoList.size()) {
            session.setAttribute("alertMsg", result + "ëª…ì˜ íšŒì›ì´ ì„±ê³µì ìœ¼ë¡œ ì¼ê´„ íƒˆí‡´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            session.setAttribute("alertMsg", "ì¼ê´„ íƒˆí‡´ ì²˜ë¦¬ ì¤‘ ì¼ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (" + result + "ëª… ì²˜ë¦¬ë¨)");
        }

        return "redirect:/admin/member";
    }
    
    // ----------------------------------------------------
    // 6. íšŒì› ê²€ìƒ‰ (ì´ë¦„) (ê¸°ì¡´ ìœ ì§€)
    // ----------------------------------------------------
    @GetMapping("/searchMemberName")
    public String searchMemberName(
        @RequestParam("keyword") String memberName, 
        Model model) {
    	
        List<Member> searchList = adminService.searchMemberByName(memberName);
        
        model.addAttribute("memberList", searchList);
        model.addAttribute("searchCondition", "searchMemberName");
        model.addAttribute("searchKeyword", memberName);
    	
    	return "admin/memberManage";
    }
    
    // ----------------------------------------------------
    // 7. íšŒì› ê²€ìƒ‰ (ì•„ì´ë””) (ê¸°ì¡´ ìœ ì§€)
    // ----------------------------------------------------
    @GetMapping("/searchMemberId")
    public String searchMemberId(
        @RequestParam("keyword") String memberId,
        Model model) {
    	
        Member m = adminService.searchMemberById(memberId);
        
        // JSP í˜¸í™˜ì„ ìœ„í•´ Listë¡œ ê°ì‹¸ê¸°
        List<Member> searchList = new ArrayList<>();
        if (m != null) {
            searchList.add(m);
        }
        
        model.addAttribute("memberList", searchList);
        model.addAttribute("searchCondition", "searchMemberId");
        model.addAttribute("searchKeyword", memberId);

        return "admin/memberManage";
    }
    
    // ****************************************************
    // ğŸŸ¢ ê²Œì‹œíŒë³„ ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ ê¸°ëŠ¥
    // ****************************************************
    
    /**
     * 1. ììœ ê²Œì‹œíŒ ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ (/admin/post/freeList)
     * [ìˆ˜ì •ë¨] AdminService ëŒ€ì‹  FreeServiceë¥¼ ì‚¬ìš©í•˜ì—¬ ëª©ë¡ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
     */
    @GetMapping("/post/freeList")
    public String freeList(
        @RequestParam(value = "currentPage", defaultValue = "1") int currentPage,
        Model model) {
        
        // 1. listCountë¥¼ FreeServiceë¥¼ í†µí•´ ì¡°íšŒ
        int listCount = freeService.selectListCount(); 
        
        // 2. Pagination ê°ì²´ ìƒì„± (Pagination ìƒì„± ë¡œì§ì€ AdminServiceì˜ ê³µí†µ ìœ í‹¸ë¦¬í‹°ë¥¼ ì‚¬ìš©í•œë‹¤ê³  ê°€ì •)
        Pagination pageInfo = adminService.getPagination(currentPage, listCount);
        
        // 3. í˜„ì¬ í˜ì´ì§€ ëª©ë¡ì„ FreeServiceë¥¼ í†µí•´ ì¡°íšŒ
        // FreeServiceì˜ selectList(currentPage)ê°€ RowBoundsë¥¼ ì´ìš©í•´ ëª©ë¡ì„ ê°€ì ¸ì˜´
        List<FreeBbs> bbsList = freeService.selectList(currentPage);
        
        model.addAttribute("bbsList", bbsList);
        model.addAttribute("pageInfo", pageInfo);
        model.addAttribute("boardName", "ììœ ê²Œì‹œíŒ");
        model.addAttribute("boardCode", "free");
        
        return "admin/postListManage"; // postListManage.jspì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš©
    }
    
    
    /**
     * 2. ì •ë³´ê³µìœ ê²Œì‹œíŒ ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ (/admin/post/infoList)
     */
    @GetMapping("/post/infoList")
    public String infoList(
        @RequestParam(value = "currentPage", defaultValue = "1") int currentPage,
        Model model) {
        
        int listCount = infoService.selectBbsListCount("INFO"); // ì •ë³´ê³µìœ ê²Œì‹œíŒ ì „ì²´ ê¸€ ìˆ˜ ì¡°íšŒ
        
        Pagination pageInfo = adminService.getPagination(currentPage, listCount);
        
        // AdminServiceì— selectInfoBbsList(Pagination pageInfo) ë©”ì„œë“œê°€ í•„ìš”
        List<InfoBbs> bbsList = infoService.selectInfoBbsList(pageInfo);
        
        model.addAttribute("bbsList", bbsList);
        model.addAttribute("pageInfo", pageInfo);
        model.addAttribute("boardName", "ì •ë³´ê³µìœ ê²Œì‹œíŒ");
        model.addAttribute("boardCode", "info");
        
        return "admin/postListManage";
    }
    
    /**
     * 3. ì§€ì‹ê³µìœ ê²Œì‹œíŒ ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ (/admin/post/knowledgeList)
     */
    @GetMapping("/post/knowledgeList")
    public String knowledgeList(
        @RequestParam(value = "currentPage", defaultValue = "1") int currentPage,
        Model model) {
        
        int listCount = adminService.selectBbsListCount("KNOWLEDGE"); // ì§€ì‹ê³µìœ ê²Œì‹œíŒ ì „ì²´ ê¸€ ìˆ˜ ì¡°íšŒ
        
        Pagination pageInfo = adminService.getPagination(currentPage, listCount);
        
        // AdminServiceì— selectKnowledgeBbsList(Pagination pageInfo) ë©”ì„œë“œê°€ í•„ìš”
        List<KnowledgeBbs> bbsList = adminService.selectKnowledgeBbsList(pageInfo);
        
        model.addAttribute("bbsList", bbsList);
        model.addAttribute("pageInfo", pageInfo);
        model.addAttribute("boardName", "ì§€ì‹ê³µìœ ê²Œì‹œíŒ");
        model.addAttribute("boardCode", "knowledge");
        
        return "admin/postListManage";
    }
    
    /**
     * 4. ìŠ¤í„°ë””ëª¨ì§‘ê²Œì‹œíŒ ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ (/admin/post/studyList)
     */
    @GetMapping("/post/studyList")
    public String studyList(
        @RequestParam(value = "currentPage", defaultValue = "1") int currentPage,
        Model model) {
        
        int listCount = adminService.selectBbsListCount("STUDY"); // ìŠ¤í„°ë””ëª¨ì§‘ê²Œì‹œíŒ ì „ì²´ ê¸€ ìˆ˜ ì¡°íšŒ
        
        Pagination pageInfo = adminService.getPagination(currentPage, listCount);
        
        // AdminServiceì— selectStudyBbsList(Pagination pageInfo) ë©”ì„œë“œê°€ í•„ìš”
        List<StudyBbs> bbsList = adminService.selectStudyBbsList(pageInfo);
        
        model.addAttribute("bbsList", bbsList);
        model.addAttribute("pageInfo", pageInfo);
        model.addAttribute("boardName", "ìŠ¤í„°ë””ëª¨ì§‘ê²Œì‹œíŒ");
        model.addAttribute("boardCode", "study");
        
        return "admin/postListManage";
    }

    /**
     * 5. ê³µì§€ì‚¬í•­ ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ (/admin/post/noticeList)
     */
    @GetMapping("/post/noticeList")
    public String noticeList(
        @RequestParam(value = "currentPage", defaultValue = "1") int currentPage,
        Model model) {
        
        int listCount = adminService.selectBbsListCount("NOTICE"); // ê³µì§€ì‚¬í•­ ì „ì²´ ê¸€ ìˆ˜ ì¡°íšŒ
        
        Pagination pageInfo = adminService.getPagination(currentPage, listCount);
        
        // AdminServiceì— selectNoticeBbsList(Pagination pageInfo) ë©”ì„œë“œê°€ í•„ìš”
        List<NoticeBbs> bbsList = adminService.selectNoticeBbsList(pageInfo);
        
        model.addAttribute("bbsList", bbsList);
        model.addAttribute("pageInfo", pageInfo);
        model.addAttribute("boardName", "ê³µì§€ì‚¬í•­");
        model.addAttribute("boardCode", "notice");
        
        return "admin/postListManage";
    }

    /**
     * 6. ITë‰´ìŠ¤ ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ (/admin/post/itList)
     */
    @GetMapping("/post/itList")
    public String itList(
        @RequestParam(value = "currentPage", defaultValue = "1") int currentPage,
        Model model) {
        
        int listCount = adminService.selectBbsListCount("IT"); // ITë‰´ìŠ¤ ì „ì²´ ê¸€ ìˆ˜ ì¡°íšŒ
        
        Pagination pageInfo = adminService.getPagination(currentPage, listCount);
        
        // AdminServiceì— selectItBbsList(Pagination pageInfo) ë©”ì„œë“œê°€ í•„ìš”
        List<ItBbs> bbsList = adminService.selectItBbsList(pageInfo);
        
        model.addAttribute("bbsList", bbsList);
        model.addAttribute("pageInfo", pageInfo);
        model.addAttribute("boardName", "ITë‰´ìŠ¤");
        model.addAttribute("boardCode", "it");
        
        return "admin/postListManage";
    }
 

}
