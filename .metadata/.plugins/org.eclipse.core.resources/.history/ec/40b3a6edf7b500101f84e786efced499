<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %> 
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>자유 게시판 관리</title>

    <link rel="stylesheet" href="<c:url value="/resources/css/adminStyle.css" />">
    <style>
        .deleted-post {
            background-color: #f8f8f8; /* 밝은 회색 배경 */
            color: #999; /* 텍스트 색상을 흐리게 */
        }
        .deleted-post a, .deleted-post .text-danger, .deleted-post .text-secondary {
            color: #999 !important;
        }
    </style>
</head>
<body>
    
    <header>
        <div class="logo">
            <img src="<c:url value="/resources/images/logo1.PNG" />" width="80">
            관리자 페이지
        </div>
    </header>

    <div class="layout">
        <%-- ✅ 사이드바: 자유 게시판 활성화 --%>
        <aside class="sidebar">
            <ul>
                <li><a href="<c:url value="/admin/dashboard" />">🏠 대시보드</a></li>
                <li><a href="<c:url value="/admin/member" />">👥 회원 관리</a></li>

                <%-- '자유 게시판'이 현재 페이지이므로 'menu-open' 및 'active' 설정 --%>
                <li id="postManageMenu" class="menu-open">
                    <a href="javascript:void(0);" class="active" onclick="toggleSubmenu('postManageMenu')">📝 게시글 관리</a>
                    <ul class="submenu">
                        <li><a href="<c:url value="/admin/post/freeList" />" class="active">자유 게시판</a></li>
                        <li><a href="<c:url value="/admin/post/infoList" />">정보 공유</a></li>
                        <li><a href="<c:url value="/admin/post/knowledgeList" />">지식 공유</a></li>
                        <li><a href="<c:url value="/admin/post/itList" />">IT 뉴스</a></li>
                        <li><a href="<c:url value="/admin/post/noticeList" />">공지 사항</a></li>
                    </ul>
                </li>
            </ul>
        </aside>

        <main class="content">
            <h1>자유 게시판 관리</h1>
            <p>자유 게시판의 게시글 목록을 확인하고 관리할 수 있습니다.</p>

            <div class="action-bar">
                <button type="button" class="btn btn-danger" onclick="bulkDelete()">일괄 삭제</button>
            </div>

            <form id="bulkDeleteForm" method="POST" action="<c:url value="/admin/post/freeBulkDelete" />" style="display:none;"></form>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckboxPost"></th>
                            <th>No.</th>
                            <th>제목</th>
                            <th>작성자</th>
                            <th>작성일</th>
                            <th>조회수</th>
                            <th>상태</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody>
                        <c:forEach var="bbs" items="${bbsList}" varStatus="status">
                            <c:set var="isDeleted" value="${bbs.freeDeleteStatus eq 'Y'}" />
                            <tr class="${isDeleted ? 'deleted-post' : ''}">
                                <td><input type="checkbox" class="itemCheckboxPost" value="${bbs.freeNo}" ${isDeleted ? 'disabled' : ''}></td>
                                <td><c:out value="${bbs.freeNo}" /></td>
                                <td>
                                    <a href="#" class="text-primary ${isDeleted ? 'text-secondary' : ''}" title="${bbs.freeTitle}">
                                        <c:out value="${bbs.freeTitle}" />
                                    </a>
                                </td>
                                <td><c:out value="${bbs.memberNo}" /></td> <%-- 실제로는 MEMBER_ID나 닉네임이 출력되어야 합니다 --%>
                                <td><fmt:formatDate value="${bbs.freeCreateDate}" pattern="yyyy-MM-dd" /></td>
                                <td><c:out value="${bbs.freeView}" /></td>
                                <td class="${isDeleted ? 'text-danger' : 'text-success'}">
                                    ${isDeleted ? '삭제됨' : '정상'}
                                </td>
                                <td>
                                    <c:choose>
                                        <c:when test="${isDeleted}">
                                            <span class="text-secondary">삭제 완료</span>
                                        </c:when>
                                        <c:otherwise>
                                            <button type="button" class="btn btn-sm btn-info" onclick="location.href='<c:url value="/admin/post/freeDetail?no=${bbs.freeNo}" />'">상세</button>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="deletePost(${bbs.freeNo})">삭제</button>
                                        </c:otherwise>
                                    </c:choose>
                                </td>
                            </tr>
                        </c:forEach>
                        <c:if test="${empty bbsList}">
                            <tr>
                                <td colspan="8" class="text-center">조회된 게시글이 없습니다.</td>
                            </tr>
                        </c:if>
                    </tbody>
                </table>
            </div>

            <%-- 페이지네이션 영역 --%>
            <div class="pagination-area">
                <c:if test="${!empty pageInfo}">
                    <a href="<c:url value="/admin/post/freeList?currentPage=1" />" class="page-link">&lt;&lt;</a>
                    <a href="<c:url value="/admin/post/freeList?currentPage=${pageInfo.currentPage - 1 < 1 ? 1 : pageInfo.currentPage - 1}" />" class="page-link">&lt;</a>
                    <c:forEach var="p" begin="${pageInfo.startPage}" end="${pageInfo.endPage}">
                        <a href="<c:url value="/admin/post/freeList?currentPage=${p}" />" class="page-link ${p == pageInfo.currentPage ? 'current-page' : ''}">
                            <c:out value="${p}" />
                        </a>
                    </c:forEach>
                    <a href="<c:url value="/admin/post/freeList?currentPage=${pageInfo.currentPage + 1 > pageInfo.maxPage ? pageInfo.maxPage : pageInfo.currentPage + 1}" />" class="page-link">&gt;</a>
                    <a href="<c:url value="/admin/post/freeList?currentPage=${pageInfo.maxPage}" />" class="page-link">&gt;&gt;</a>
                </c:if>
            </div>

        </main>
    </div>
    
    <script>
    /**
     * 개별 게시글 삭제 처리 함수
     */
    function deletePost(bbsNo) {
        // [수정 필요] confirm 대신 커스텀 모달 사용 권장
        if (confirm(`${bbsNo}번 게시글을 정말로 삭제 처리하시겠습니까?`)) {
            // 실제 삭제 로직 (POST 요청)
            fetch('<c:url value="/admin/post/freeDelete" />', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `bbsNo=${bbsNo}`
            })
            .then(response => response.text())
            .then(result => {
                if (result.trim() === 'success') {
                    alert('게시글이 삭제 처리되었습니다.');
                    location.reload(); // 성공 시 페이지 새로고침
                } else {
                    alert('게시글 삭제 처리에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('요청 중 오류가 발생했습니다.');
            });
        }
    }


    /**
     * 일괄 삭제 처리 함수 (선택된 항목의 개수 표시 기능 포함)
     */
    function bulkDelete() {
        const allCheckboxes = document.querySelectorAll('.itemCheckboxPost');
        const selectedCheckboxes = [];

        // 선택된 체크박스 중, 부모 행에 'deleted-post' 클래스가 없는 것만 필터링합니다.
        // 이렇게 하면 이미 삭제된 게시글은 일괄 삭제 대상에서 제외되고 정확한 카운트만 반영됩니다.
        allCheckboxes.forEach(checkbox => {
            if (checkbox.checked && !checkbox.closest('tr').classList.contains('deleted-post')) {
                selectedCheckboxes.push(checkbox);
            }
        });

        if (selectedCheckboxes.length === 0) {
            alert('일괄 삭제할 게시글을 1개 이상 선택해 주세요. (이미 삭제된 게시글은 제외됩니다.)'); return;
        }
        
        // 💡 총 선택된 게시글 건수를 템플릿 리터럴로 정확히 표시합니다.
        if (confirm(`총 ${selectedCheckboxes.length}건의 게시글을 일괄 삭제 처리하시겠습니까?`)) {
            const form = document.getElementById('bulkDeleteForm');
            form.innerHTML = '';
            
            // 선택된 게시글 번호들을 hidden input으로 추가
            selectedCheckboxes.forEach(checkbox => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden'; 
                // name='bbsNoList'는 Controller에서 받는 @RequestParam 이름일 가능성이 높으므로 유지
                hiddenInput.name = 'bbsNoList'; 
                hiddenInput.value = checkbox.value;
                form.appendChild(hiddenInput);
            });
            form.submit();
        }
    }


    /**
     * 전체 선택 및 개별 선택 로직
     */
    document.addEventListener('DOMContentLoaded', (event) => {
        const selectAllCheckbox = document.getElementById('selectAllCheckboxPost');
        // 'disabled'되지 않은, 즉 삭제 가능한 항목만 대상으로 합니다.
        const itemCheckboxes = document.querySelectorAll('.itemCheckboxPost:not([disabled])'); 
        
        selectAllCheckbox.addEventListener('change', function() { 
            itemCheckboxes.forEach(checkbox => { 
                checkbox.checked = this.checked; 
            }); 
        });

        itemCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const checkedItems = document.querySelectorAll('.itemCheckboxPost:checked:not([disabled])').length;
                if (!checkbox.checked) { 
                    selectAllCheckbox.checked = false; 
                } else if (checkedItems === itemCheckboxes.length) { 
                    selectAllCheckbox.checked = true; 
                }
            });
        });

        // 💡 [추가] DOM 로드 시 전체 선택 체크박스 상태 초기화
        // 삭제 가능한 모든 항목이 체크되어 있다면 '전체 선택'을 체크 상태로 만듭니다.
        const initialCheckedItems = document.querySelectorAll('.itemCheckboxPost:checked:not([disabled])').length;
        if (initialCheckedItems > 0 && initialCheckedItems === itemCheckboxes.length) {
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.checked = false;
        }

    });
 </script>
</body>
</html>
