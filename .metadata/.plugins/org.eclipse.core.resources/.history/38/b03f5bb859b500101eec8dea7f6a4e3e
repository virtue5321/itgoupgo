<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>게시글 관리</title>
  <%-- 💡 CSS 파일 경로 확인 --%>
  <link rel="stylesheet" href="<c:url value="/resources/css/adminStyle.css" />">
  <style>
    /* 💡 [추가] 페이징바 스타일: UI를 깔끔하게 유지하기 위한 필수 스타일 */
    .pagination-container {
        display: flex;
        justify-content: center;
        padding: 20px 0;
        gap: 5px;
    }
    .pagination-container a, .pagination-container span {
        padding: 8px 12px;
        text-decoration: none;
        color: #333;
        border: 1px solid #ddd;
        border-radius: 4px;
        transition: background-color 0.3s;
    }
    .pagination-container a:hover {
        background-color: #f0f0f0;
    }
    .pagination-container .active {
        background-color: #5a5ce8; /* 사용자님의 기존 버튼 색상으로 추정되는 색 */
        color: white;
        border-color: #5a5ce8;
    }
    /* 상태 표시 색상 */
    .status-active { color: #28a745; font-weight: bold; } /* 정상 */
    .status-deleted { color: #dc3545; font-weight: bold; } /* 삭제됨 */
  </style>
</head>
<body>

  <%-- 💡 헤더 및 네비게이션 포함 (adminHeader.jsp를 포함한다고 가정) --%>
  <%-- <c:import url="../common/adminHeader.jsp" /> --%>

  <div class="wrap">
    
    <%-- 💡 관리자용 사이드바 포함 (adminSidebar.jsp를 포함한다고 가정) --%>
    <%-- <c:import url="../common/adminSidebar.jsp" /> --%>

    <div class="content">
      <h2 class="page-title">게시글 관리</h2>

      <div class="search-area">
        <form action="${pageContext.request.contextPath}/admin/posts/list" method="get">
          <select name="searchType" class="search-select">
            <option value="title">제목</option>
            <option value="memberNo">작성자 No</option>
            <option value="boardType">게시판</option>
          </select>
          <input type="text" name="searchKeyword" placeholder="검색어를 입력하세요" class="search-input" value="${param.searchKeyword}">
          <button type="submit" class="search-btn">검색</button>
        </form>
      </div>

      <div class="board-top">
        <div class="count-text">
          총 게시글 수: <strong><c:out value="${pageInfo.listCount}" default="0"/></strong>건
        </div>
        <div class="action-buttons">
          <%-- 💡 선택된 게시글 'N' (삭제 상태)로 변경하는 버튼 --%>
          <button type="button" class="btn btn-warning" onclick="confirmPostAction('DELETE');">
            선택된 게시글 삭제
          </button>
          <%-- 💡 선택된 게시글 'Y' (정상 상태)로 변경하는 버튼 --%>
          <button type="button" class="btn btn-success" onclick="confirmPostAction('RESTORE');">
            선택된 게시글 복구
          </button>
        </div>
      </div>

      <%-- 💡 게시글 상태 변경을 위한 폼 (POST 요청) --%>
      <form id="postActionForm" action="${pageContext.request.contextPath}/admin/posts/updateStatus" method="POST">
        
        <table class="table">
          <thead>
            <tr>
              <th style="width: 50px;">
                <input type="checkbox" id="selectAllCheckboxPost">
              </th>
              <th style="width: 50px;">No.</th>
              <th style="width: 100px;">게시판</th>
              <th>제목</th>
              <th style="width: 100px;">작성자 No</th>
              <th style="width: 120px;">작성일</th>
              <th style="width: 80px;">조회수</th>
              <th style="width: 80px;">상태</th>
            </tr>
          </thead>
          <tbody>
            <%-- 💡 postList는 컨트롤러에서 전달받은 게시글 목록입니다. --%>
            <c:choose>
              <c:when test="${not empty postList}">
                <c:forEach var="post" items="${postList}">
                  <tr>
                    <td>
                      <input type="checkbox" class="itemCheckboxPost" value="${post.postNo}">
                    </td>
                    <td><c:out value="${post.postNo}" /></td>
                    <td><c:out value="${post.boardType}" /></td> <%-- 예시: 자유, 지식, 공지 등 --%>
                    <td>
                      <%-- 상세 페이지로 이동 링크 (boardType에 따라 경로가 달라질 수 있음) --%>
                      <a href="<c:url value="/${post.boardType}/detail?no=${post.postNo}"/>" class="title-link">
                        <c:out value="${post.postTitle}" />
                      </a>
                    </td>
                    <td><c:out value="${post.memberNo}" /></td>
                    <td>
                      <%-- 날짜 포맷팅 --%>
                      <fmt:formatDate value="${post.postCreateDate}" pattern="yyyy-MM-dd" />
                    </td>
                    <td><c:out value="${post.postView}" /></td>
                    <td>
                      <c:choose>
                        <c:when test="${post.postDeleteStatus eq 'Y'}">
                          <span class="status-active">정상</span>
                        </c:when>
                        <c:otherwise>
                          <span class="status-deleted">삭제됨</span>
                        </c:otherwise>
                      </c:choose>
                    </td>
                  </tr>
                </c:forEach>
              </c:when>
              <c:otherwise>
                <tr>
                  <td colspan="8" class="no-data">조회된 게시글이 없습니다.</td>
                </tr>
              </c:otherwise>
            </c:choose>
          </tbody>
        </table>

        <%-- 💡 실제 상태 변경 작업을 위한 Hidden 필드 --%>
        <input type="hidden" name="actionType" id="actionType" value="">
        <%-- 💡 선택된 게시글 번호 목록은 JavaScript에서 동적으로 추가됩니다 --%>
      </form>
      
      <%-- 💡 페이징 바 영역 --%>
      <div class="pagination-container">
        <%-- 💡 이전 페이지 그룹 --%>
        <c:if test="${pageInfo.currentPage > pageInfo.pageLimit}">
            <a href="${pageContext.request.contextPath}/admin/posts/list?currentPage=${pageInfo.startPage - 1}&${queryStr}">&laquo;</a>
        </c:if>

        <%-- 💡 페이지 번호 목록 --%>
        <c:forEach var="p" begin="${pageInfo.startPage}" end="${pageInfo.endPage}">
            <c:choose>
                <c:when test="${p eq pageInfo.currentPage}">
                    <span class="active">${p}</span>
                </c:when>
                <c:otherwise>
                    <a href="${pageContext.request.contextPath}/admin/posts/list?currentPage=${p}&${queryStr}">${p}</a>
                </c:otherwise>
            </c:choose>
        </c:forEach>

        <%-- 💡 다음 페이지 그룹 --%>
        <c:if test="${pageInfo.currentPage < pageInfo.maxPage and pageInfo.endPage < pageInfo.maxPage}">
            <a href="${pageContext.request.contextPath}/admin/posts/list?currentPage=${pageInfo.endPage + 1}&${queryStr}">&raquo;</a>
        </c:if>
      </div>

    </div>
  </div>

  <script>
    // 1. 게시글 상태 변경 처리 함수
    function confirmPostAction(action) {
        const selectedCheckboxes = document.querySelectorAll('.itemCheckboxPost:checked');
        const form = document.getElementById('postActionForm');
        const actionTypeInput = document.getElementById('actionType');

        if (selectedCheckboxes.length === 0) {
            alert('먼저 처리할 게시글을 선택해주세요.');
            return;
        }

        let message = '';
        if (action === 'DELETE') {
            message = selectedCheckboxes.length + '개의 게시글을 정말로 삭제 처리(상태: N) 하시겠습니까?';
            actionTypeInput.value = 'N'; // 삭제 상태
        } else if (action === 'RESTORE') {
            message = selectedCheckboxes.length + '개의 게시글을 정말로 복구 처리(상태: Y) 하시겠습니까?';
            actionTypeInput.value = 'Y'; // 정상 상태
        } else {
            return;
        }

        if (confirm(message)) {
            // 기존에 추가된 postNoList를 모두 제거
            form.querySelectorAll('input[name="postNoList"]').forEach(input => input.remove());

            // 선택된 체크박스의 value를 hidden input으로 폼에 추가하여 전송
            selectedCheckboxes.forEach(checkbox => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'postNoList'; // Controller의 @RequestParam 이름과 일치
                hiddenInput.value = checkbox.value;
                form.appendChild(hiddenInput);
            });
            
            form.submit(); // POST 요청 전송
        }
    }

    // 2. 체크박스 전체 선택/해제 기능
    document.addEventListener('DOMContentLoaded', (event) => {
        const selectAllCheckbox = document.getElementById('selectAllCheckboxPost');
        const itemCheckboxes = document.querySelectorAll('.itemCheckboxPost');

        // 전체 선택 체크박스 클릭 시
        selectAllCheckbox.addEventListener('change', function() {
            itemCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
        
        // 개별 항목 체크박스 상태 변경 시
        itemCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const checkedItems = document.querySelectorAll('.itemCheckboxPost:checked').length;
                if (!checkbox.checked) {
                    // 하나라도 해제되면 전체 선택 해제
                    selectAllCheckbox.checked = false;
                } else if (checkedItems === itemCheckboxes.length) {
                    // 모든 항목이 선택되면 전체 선택
                    selectAllCheckbox.checked = true;
                }
            });
        });
    });
 </script>
</body>
</html>
