<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>회원 관리 | IT GOUPGO Community</title>
  
  <!-- Tailwind CSS CDN 로드 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Inter 폰트 사용 -->
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8f8fa; }
    /* 기존 스타일 유지 및 통합 */
    .table-container { 
        overflow-x: auto; 
        width: 100%; 
        border-radius: 8px; 
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
    }
    .data-table { 
        width: 100%; 
        border-collapse: separate; 
        border-spacing: 0;
    }
    .data-table th, .data-table td {
        padding: 12px 15px;
        text-align: center;
        border-bottom: 1px solid #e5e7eb; /* Gray-200 */
    }
    .data-table th {
        background-color: #5a5ce8; /* 메인 색상 */
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .data-table tr:hover { background-color: #f5f5f7; }
    .pagination-container {
        display: flex;
        justify-content: center;
        padding: 20px 0;
        gap: 5px;
    }
    .pagination-container a, .pagination-container span {
        padding: 8px 12px;
        text-decoration: none;
        color: #333;
        border: 1px solid #ddd;
        border-radius: 4px;
        transition: background-color 0.3s, border-color 0.3s;
    }
    .pagination-container a:hover {
        background-color: #e0e0e0;
        border-color: #c0c0c0;
    }
    .pagination-container .active {
        background-color: #5a5ce8; /* 사용자님의 기존 버튼 색상 */
        color: white;
        border-color: #5a5ce8;
        font-weight: bold;
    }
    /* 테이블 첫 번째/마지막 행 모서리 둥글게 */
    .data-table tr:first-child th:first-child { border-top-left-radius: 8px; }
    .data-table tr:first-child th:last-child { border-top-right-radius: 8px; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- ========================================================= -->
  <!-- 1. HEADER & NAVIGATION BAR (헤더 및 메뉴바) -->
  <!-- ========================================================= -->
  <header class="sticky top-0 z-50 bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4 md:justify-start md:space-x-10">
        
        <!-- 로고/제목 -->
        <div class="flex justify-start lg:w-0 lg:flex-1">
          <a href="/" class="text-2xl font-extrabold text-[#5a5ce8] tracking-tight">
            IT GOUPGO Community
          </a>
        </div>

        <!-- 메인 메뉴 -->
        <nav class="hidden md:flex space-x-8">
          <a href="/notice/list" class="text-base font-medium text-gray-500 hover:text-gray-900 transition duration-150 ease-in-out">공지사항</a>
          <a href="/it/list" class="text-base font-medium text-gray-500 hover:text-gray-900 transition duration-150 ease-in-out">IT 뉴스</a>
          <a href="/info/list" class="text-base font-medium text-gray-500 hover:text-gray-900 transition duration-150 ease-in-out">정보 공유</a>
          <a href="/knowledge/list" class="text-base font-medium text-gray-500 hover:text-gray-900 transition duration-150 ease-in-out">지식 공유</a>
          <a href="/study/list" class="text-base font-medium text-gray-500 hover:text-gray-900 transition duration-150 ease-in-out">스터디 모집</a>
          <a href="/free/list" class="text-base font-medium text-gray-500 hover:text-gray-900 transition duration-150 ease-in-out">자유 게시판</a>
          <!-- 현재 페이지는 관리자 페이지이므로 관리자 메뉴 강조 -->
          <a href="/admin/member" class="text-base font-medium text-white bg-red-500 px-3 py-1 rounded-full hover:bg-red-600 transition duration-150 ease-in-out">관리자 메뉴</a>
        </nav>

        <!-- 로그인/로그아웃 및 사용자 상태 -->
        <div class="hidden md:flex items-center justify-end md:flex-1 lg:w-0">
          <c:choose>
            <c:when test="${!empty loginMember}">
              <!-- 로그인 상태일 경우 -->
              <span class="text-gray-600 mr-4">${loginMember.memberNickname}님</span>
              <a href="/member/logout" class="ml-4 whitespace-nowrap inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-red-500 hover:bg-red-600">
                로그아웃
              </a>
            </c:when>
            <c:otherwise>
              <!-- 비로그인 상태일 경우 -->
              <a href="/member/login" class="whitespace-nowrap text-base font-medium text-gray-500 hover:text-gray-900">
                로그인
              </a>
              <a href="/member/signup" class="ml-8 whitespace-nowrap inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-[#5a5ce8] hover:bg-indigo-700">
                회원가입
              </a>
            </c:otherwise>
          </c:choose>
        </div>
      </div>
    </div>
  </header>

  <!-- ========================================================= -->
  <!-- 2. MAIN CONTENT (본문) - 기존 memberManage.jsp 내용 포함 -->
  <!-- ========================================================= -->
  <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
      <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-3">회원 관리</h1>

      <!-- 검색 폼 -->
      <form action="<c:url value="/admin/memberManage" />" method="get" class="flex flex-wrap items-center gap-4 mb-6 p-4 border rounded-lg bg-gray-50">
        <label for="searchKey" class="font-medium text-gray-700">검색 조건:</label>
        <select name="searchKey" id="searchKey" class="border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
          <option value="memberNo" <c:if test="${param.searchKey == 'memberNo'}">selected</c:if>>회원 번호</option>
          <option value="memberId" <c:if test="${param.searchKey == 'memberId'}">selected</c:if>>아이디</option>
          <option value="memberNickname" <c:if test="${param.searchKey == 'memberNickname'}">selected</c:if>>닉네임</option>
        </select>

        <input type="text" name="searchValue" placeholder="검색어 입력" value="${param.searchValue}" class="border border-gray-300 rounded-md p-2 w-full sm:w-60 focus:ring-indigo-500 focus:border-indigo-500">
        
        <button type="submit" class="px-4 py-2 bg-[#5a5ce8] text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out">
          검색
        </button>
      </form>

      <!-- 선택된 회원 탈퇴/정지 버튼 -->
      <div class="flex justify-end gap-3 mb-4">
        <button type="button" onclick="confirmAction('delete')" class="px-5 py-2 border border-red-500 text-red-500 font-semibold rounded-md hover:bg-red-50 transition duration-150 ease-in-out">
          선택 회원 탈퇴
        </button>
        <button type="button" onclick="confirmAction('suspend')" class="px-5 py-2 border border-yellow-500 text-yellow-500 font-semibold rounded-md hover:bg-yellow-50 transition duration-150 ease-in-out">
          선택 회원 정지
        </button>
      </div>

      <!-- 회원 목록 테이블 -->
      <form id="memberActionForm" action="<c:url value="/admin/processMemberAction" />" method="post">
        <input type="hidden" id="actionType" name="actionType" value="">
        <div class="table-container bg-white">
          <table class="data-table">
            <thead>
              <tr>
                <th class="w-10">
                  <input type="checkbox" id="selectAllCheckboxMember" class="form-checkbox text-[#5a5ce8] rounded">
                </th>
                <th class="w-16">No</th>
                <th class="w-32">아이디</th>
                <th class="w-32">닉네임</th>
                <th class="w-48">가입일</th>
                <th class="w-32">등급</th>
                <th class="w-32">상태</th>
                <th class="w-20">관리</th>
              </tr>
            </thead>
            <tbody>
              <c:choose>
                <c:when test="${!empty memberList}">
                  <c:forEach var="member" items="${memberList}" varStatus="status">
                    <tr class="text-sm">
                      <td>
                        <input type="checkbox" name="memberNoList" value="${member.memberNo}" class="itemCheckboxMember form-checkbox text-[#5a5ce8] rounded">
                      </td>
                      <td>${member.memberNo}</td>
                      <td class="text-left">${member.memberId}</td>
                      <td>${member.memberNickname}</td>
                      <td>
                        <fmt:formatDate value="${member.enrollDate}" pattern="yyyy-MM-dd"/>
                      </td>
                      <td>${member.memberStatus == 'A' ? '관리자' : (member.memberStatus == 'S' ? '정지' : '일반')}</td>
                      <td>
                          <c:choose>
                              <c:when test="${member.memberDeleteStatus == 'Y'}">탈퇴</c:when>
                              <c:when test="${member.memberStatus == 'S'}">정지</c:when>
                              <c:otherwise>활동 중</c:otherwise>
                          </c:choose>
                      </td>
                      <td>
                        <a href="<c:url value="/admin/memberDetail?memberNo=${member.memberNo}" />" class="text-[#5a5ce8] hover:underline text-xs font-medium">상세</a>
                      </td>
                    </tr>
                  </c:forEach>
                </c:when>
                <c:otherwise>
                  <tr class="text-center">
                    <td colspan="8" class="py-6 text-gray-500">조회된 회원 정보가 없습니다.</td>
                  </tr>
                </c:otherwise>
              </c:choose>
            </tbody>
          </table>
        </div>
      </form>

      <!-- 페이징 처리 -->
      <c:if test="${!empty pi}">
        <div class="pagination-container">
          <%-- 맨 앞으로 --%>
          <a href="<c:url value="/admin/memberManage?currentPage=1&searchKey=${param.searchKey}&searchValue=${param.searchValue}" />" title="맨 처음 페이지">
            &laquo;
          </a>
          
          <%-- 이전 페이지로 --%>
          <a href="<c:url value="/admin/memberManage?currentPage=${pi.currentPage - 1}&searchKey=${param.searchKey}&searchValue=${param.searchValue}" />" title="이전 페이지"
             <c:if test="${pi.currentPage == 1}">onclick="return false;" class="text-gray-400 cursor-not-allowed"</c:if>>
            &lt;
          </a>

          <%-- 페이지 번호 목록 --%>
          <c:forEach var="p" begin="${pi.startPage}" end="${pi.endPage}">
            <c:choose>
              <c:when test="${p == pi.currentPage}">
                <span class="active">${p}</span>
              </c:when>
              <c:otherwise>
                <a href="<c:url value="/admin/memberManage?currentPage=${p}&searchKey=${param.searchKey}&searchValue=${param.searchValue}" />">${p}</a>
              </c:otherwise>
            </c:choose>
          </c:forEach>

          <%-- 다음 페이지로 --%>
          <a href="<c:url value="/admin/memberManage?currentPage=${pi.currentPage + 1}&searchKey=${param.searchKey}&searchValue=${param.searchValue}" />" title="다음 페이지"
             <c:if test="${pi.currentPage == pi.maxPage}">onclick="return false;" class="text-gray-400 cursor-not-allowed"</c:if>>
            &gt;
          </a>

          <%-- 맨 끝으로 --%>
          <a href="<c:url value="/admin/memberManage?currentPage=${pi.maxPage}&searchKey=${param.searchKey}&searchValue=${param.searchValue}" />" title="맨 끝 페이지">
            &raquo;
          </a>
        </div>
      </c:if>

    </div>
  </main>

  <!-- ========================================================= -->
  <!-- 3. FOOTER (푸터) -->
  <!-- ========================================================= -->
  <footer class="bg-gray-800 text-white mt-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="md:flex md:justify-between">
        <div class="mb-6 md:mb-0">
          <h5 class="text-xl font-bold mb-2">IT GOUPGO Community</h5>
          <p class="text-sm text-gray-400">함께 성장하는 개발자 커뮤니티</p>
        </div>
        <div class="grid grid-cols-2 gap-8 sm:gap-6 sm:grid-cols-3">
          <div>
            <h6 class="mb-4 text-sm font-semibold uppercase text-white">커뮤니티</h6>
            <ul class="text-gray-400 space-y-2">
              <li><a href="/notice/list" class="hover:text-[#5a5ce8] transition duration-150">공지사항</a></li>
              <li><a href="/it/list" class="hover:text-[#5a5ce8] transition duration-150">IT 뉴스</a></li>
              <li><a href="/free/list" class="hover:text-[#5a5ce8] transition duration-150">자유 게시판</a></li>
            </ul>
          </div>
          <div>
            <h6 class="mb-4 text-sm font-semibold uppercase text-white">기술 공유</h6>
            <ul class="text-gray-400 space-y-2">
              <li><a href="/info/list" class="hover:text-[#5a5ce8] transition duration-150">정보 공유</a></li>
              <li><a href="/knowledge/list" class="hover:text-[#5a5ce8] transition duration-150">지식 공유</a></li>
              <li><a href="/study/list" class="hover:text-[#5a5ce8] transition duration-150">스터디 모집</a></li>
            </ul>
          </div>
          <div>
            <h6 class="mb-4 text-sm font-semibold uppercase text-white">Admin</h6>
            <ul class="text-gray-400 space-y-2">
              <li><a href="/admin/member" class="hover:text-red-400 transition duration-150">회원 관리</a></li>
              <li><a href="/admin/bbs" class="hover:text-red-400 transition duration-150">게시글 관리</a></li>
            </ul>
          </div>
        </div>
      </div>
      <hr class="my-6 border-gray-700 sm:mx-auto lg:my-8" />
      <div class="text-center">
        <span class="text-sm text-gray-500 sm:text-center">© 2025 IT GOUPGO Community. All Rights Reserved.</span>
      </div>
    </div>
  </footer>

 <script>
    /**
     * 회원 관리 관련 액션 처리 (탈퇴/정지)
     * @param {string} action - 'delete' 또는 'suspend'
     */
    function confirmAction(action) {
        const selectedCheckboxes = document.querySelectorAll('.itemCheckboxMember:checked');
        
        if (selectedCheckboxes.length === 0) {
            alert('먼저 처리할 회원을 한 명 이상 선택해주세요.');
            return;
        }

        let confirmMessage = '';
        if (action === 'delete') {
            confirmMessage = `${selectedCheckboxes.length}명의 회원을 정말로 탈퇴 처리하시겠습니까? (되돌릴 수 없음)`;
        } else if (action === 'suspend') {
            confirmMessage = `${selectedCheckboxes.length}명의 회원을 정말로 정지 처리하시겠습니까?`;
        }

        // alert/confirm 대신 모달/커스텀 메시지 박스를 사용해야 하지만,
        // 현재는 콘솔 환경의 제약으로 인해 alert을 사용합니다.
        if (confirm(confirmMessage)) {
            const form = document.getElementById('memberActionForm');
            const actionTypeInput = document.getElementById('actionType');
            
            // 1. 액션 타입 설정
            actionTypeInput.value = action; 

            // 2. 이전에 추가된 memberNoList hidden input 제거
            form.querySelectorAll('input[name="memberNoList"][type="hidden"]').forEach(input => input.remove());

            // 3. 선택된 체크박스의 value를 hidden input으로 폼에 추가하여 전송
            selectedCheckboxes.forEach(checkbox => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'memberNoList'; // Controller의 @RequestParam 이름과 일치
                hiddenInput.value = checkbox.value;
                form.appendChild(hiddenInput);
            });
            
            form.submit(); // POST 요청 전송
        }
    }

    // 4. 체크박스 전체 선택/해제 기능
    document.addEventListener('DOMContentLoaded', (event) => {
        const selectAllCheckbox = document.getElementById('selectAllCheckboxMember');
        const itemCheckboxes = document.querySelectorAll('.itemCheckboxMember');

        selectAllCheckbox.addEventListener('change', function() {
            itemCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
        
        itemCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const checkedItems = document.querySelectorAll('.itemCheckboxMember:checked').length;
                if (!checkbox.checked) {
                    selectAllCheckbox.checked = false;
                } else if (checkedItems === itemCheckboxes.length) {
                    selectAllCheckbox.checked = true;
                }
            });
        });

        // 현재 검색 조건을 유지하기 위해 검색 폼의 select 값을 복원
        const urlParams = new URLSearchParams(window.location.search);
        const searchKey = urlParams.get('searchKey');
        const searchSelect = document.getElementById('searchKey');
        if (searchKey && searchSelect) {
            searchSelect.value = searchKey;
        }
    });
 </script>
</body>
</html>
